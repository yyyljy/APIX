# APIX L1 이벤트/AML 파이프라인 기술명세서 (v1.0)

## 1. 시스템 구성
- Runtime: Golang 1.21+, Gin Framework
- Messaging: Apache Kafka
- Storage: PostgreSQL (추천) + Redis(집계 캐시)
- L1: Avalanche C-Chain 호환 L1 (chain id 402)

## 2. 컴포넌트 상세
### 2.1 collector-ws (Primary Collector)
- Protocol: WebSocket `eth_subscribe`
- Method: `eth_subscribe("logs", filter)`
- Checkpoint: `consumer_cursor` table에 `last_processed_block` 저장
- 복구: 연결 종료 시 즉시 재접속, 지수 백오프 적용
- replay: 마지막 커서 기준 누락 구간 `eth_getLogs`로 보정

### 2.2 collector-webhook (Auxiliary)
- Endpoint: `POST /webhooks/apix-l1`
- 역할: WSS 수집 보완 및 수집 정합성 점검
- `tx_hash` 단위로 mismatch 로그 적재
- signature 검증 실패/중복은 즉시 경보

### 2.3 Normalizer
- ABI Decode 수행
- 타입 변환: uint256 -> decimal string
- 이벤트 규격 검증 후 `normalized` 발행
- 미정의 이벤트는 `unknown`으로 보관 후 DLQ 가능

### 2.4 Risk Engine
- 입력: normalized 이벤트 스트림
- 룰 기반 + 윈도우 집계 점수 계산
- 결과 토픽 발행: `apix.risk.score.v1`, `apix.risk.alert.v1`
- Redis TTL 윈도우 캐시 사용 (예: 1m, 5m, 1h)

### 2.5 Admin API (Gin)
- 운영 조회/제어 API 제공
- API Key 또는 Bearer 인증 적용(운영 영역)
- 재처리/룰 reload 등 제어는 감사 로그 기록

## 3. 토픽 설계
### 3.1 토픽 목록
- `apix.l1.events.raw.v1`
- `apix.l1.events.normalized.v1`
- `apix.risk.score.v1`
- `apix.risk.alert.v1`
- `apix.l1.events.mismatch.v1`
- `apix.l1.events.deadletter.v1`

### 3.2 메시지 키 정책
- Raw/Normalized: `dedupe_key` 우선 키 사용
- Risk: `wallet` + score window

## 4. 멱등/재조정 정책
- 멱등 키: `chain_id|tx_hash|log_index`
- 중복 이벤트: 처리 skip + duplicate_count 증가
- reorg 처리: `removed=true` 수신 시 상태 전이(`confirmed -> reverted`)
- Finality: 기본 12 블록 확인 뒤 finalized 처리

## 5. 스키마(최소 필수)
### Raw Event
- chain_id, block_number, block_hash, tx_hash, log_index, address, topics, data, removed, captured_at, source, dedupe_key

### Normalized Event
- event_id, dedupe_key, event_type, wallet, api_id, plan_id, amount, token_symbol, status, block_number, timestamp, risk_context

### Risk Score
- wallet, score, grade, signals, created_at, ttl_sec

### Alert
- wallet, score_snapshot, rule_ids, risk_grade, status, assigned_to, notes, created_at

## 6. DB 스키마(요약)
1. `l1_events_raw`
   - `dedupe_key` unique
   - 상태: raw/normalized/fail
2. `l1_events_normalized`
   - 이벤트 분류, 정규화 결과, risk_context JSON
3. `risk_scores`
   - window(분위기 단위), signal_set
4. `risk_alerts`
   - 상태 변경 로그(OPEN/ACK/RESOLVED)
5. `webhook_mismatch`
   - `tx_hash`, `wss_seen_at`, `webhook_seen_at`, `mismatch_type`
6. `consumer_cursor`
   - service_name, chain_id, last_block, status
7. `dlq_events`
   - topic, payload, reason, retry_count

## 7. 보안
- 시크릿은 환경변수/시크릿 스토어 분리
- Webhook 입력은 서명/타임스탬프 검증
- 감사 로그는 append-only + soft delete 금지
- 운영 API는 IP 화이트리스트 + Rate Limit 고려

## 8. 장애 대응
- WS disconnect: 즉시 재연결, 재시도 한도 내 복구
- Kafka producer 오류: retry + backoff + circuit breaker
- Kafka lag 상승: autoscale consumer 또는 파티션 정책 점검
- DLQ 누적 임계치 초과: 즉시 경보 + 운영 개입

## 9. 운영 지표
- ingestion_lag_sec, kafka_lag, duplicate_rate, replay_duration_sec
- webhook_mismatch_count, dlq_size, replay_jobs_count
- risk_alert_critical_count

## 10. 릴리스 전략
1. 블루-그린/카나리 배포
2. Collector 단독 배포 후 정상성 검증
3. Normalizer + Risk Engine 순차 기동
4. API/운영 대시보드는 마지막 단계에 노출
