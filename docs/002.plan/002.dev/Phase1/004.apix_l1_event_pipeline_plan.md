# APIX L1 이벤트 수집/분석 플랫폼 기획안 (v1.0)

## 1. 배경 및 목표
- Avalanche L1(APIX, Chain ID 402) 기반으로 이벤트 중심 데이터 파이프라인을 구성한다.
- `의존성 0` 원칙에 맞게 결제/권한/정산의 최종 검증은 SDK + 온체인 L1만 수행한다.
- 백엔드(Gin)는 수집, 정규화, 집계, AML/남용 탐지, 운영 대시보드/알림 역할로 한정한다.
- WebSocket 수집을 Primary로, AvaCloud Webhook은 보조 검증 채널로 활용한다.

## 2. 핵심 운영 철학
1. 신뢰 경계 분리
   - L1 이벤트는 최종 진실 근거.
   - 백엔드는 체인 이벤트 기반 집계 결과만 제공.
2. 누락 방지 우선
   - WS 실시간 수집 + 블록 replay gap 보정.
   - Webhook으로 보조 비교(mismatch 탐지).
3. 무중단/복구 중심 설계
   - 장애 시 자동 재시도, 재처리, DLQ, 운영 수동 복구 절차 제공.
4. AML/이상거래 탐지 내재화
   - 실시간 위험 점수, 등급, 경보를 운영 의사결정에 지원.

## 3. 사용자/운영 시나리오
- SDK 사용자
  - L1에 tx를 전송하고, 응답 txHash/영수증을 기준으로 동작.
- 백엔드 운영자
  - 이벤트 적재/처리 상태 확인, risk alert 조회, replay·재처리 실행.
- 분석/지원팀
  - 지갑별 사용량, 비용 지표, 분쟁 대응 로그 조회.

## 4. 기능 범위
### 4.1 수집 범위
- `WebSocket` `eth_subscribe(logs)` 기반 이벤트 구독
- L1 RPC(HTTPS) 보조로 블록 단위 로그 조회
- AvaCloud Webhook 수신 수단 보조 보강

### 4.2 백엔드 기능
- 이벤트 Raw 수집 및 정규화
- 멱등 처리 (`chain_id + tx_hash + log_index`)
- 재조정(reorg) 대응 (`removed`, finality depth)
- DLQ 및 수동/자동 재처리
- risk score 계산 및 alert 생성

### 4.3 운영 기능
- 수집 지연, Kafka lag, mismatch, DLQ 모니터링
- API 조회/필터링
- 규칙/임계치 hot-reload
- Replay/재시작 제어

## 5. 아키텍처
1. SDK/외부 서비스: tx 발행 + L1 이벤트를 체인에 반영
2. WSS Collector: 로그 구독, gap 감지, raw publish
3. Webhook Receiver(보조): 수신 이벤트와 WSS 이벤트 교차비교
4. Kafka Raw Topic: 정합성 유지 raw 입력
5. Normalizer: ABI decode, 이벤트 타입 분류, 표준 이벤트 생성
6. Risk Engine: 패턴 매칭 + 점수 계산
7. Alert/Metric Topic: AML/남용 이벤트 배포
8. Gin Admin API: 조회/운영/제어 API 제공
9. Storage: 이벤트/alert/미스매치/재처리 상태 보존

## 6. 데이터 파이프라인 정책
- 멱등키: `dedupe_key = chain_id|tx_hash|log_index`
- 중복 처리: 동일 키 수신 시 수락/무시 정책 + 카운트만 기록
- 처리 순서: 파티션 기준으로 블록 내 순서 보존을 우선
- 실패 처리: 정합 실패/스키마 오류/ABI decode 실패는 DLQ로 이동

## 7. Webhook 활용 위치
- 1차 수집 아님(Primary는 WSS)
- 보조 지표로서 mismatch 탐지
- 수집 정합성 점검: `wss_seen` vs `webhook_seen`
- 장애/리커버리 시 교차검증 근거 제공

## 8. AML/이상거래 탐지 요구
### 8.1 실시간 룰
- 짧은 구간 호출 폭증 (1분/5분)
- 실패율 급증 (revert/error ratio)
- 결제액 급변
- 신규 지갑 초반 과도 사용
- 동일 주체 다중 API 키/지갑 패턴
- 블록 구간 과다 이벤트 집중

### 8.2 점수/등급
- 점수 범위: 0~100
- 0~39: NORMAL
- 40~69: WARN
- 70~89: SUSPECT
- 90~100: CRITICAL

### 8.3 대응 정책
- WARN: 알림 + 추적 시작
- SUSPECT: 쿼터/속도 제한 권고, 담당자 지정
- CRITICAL: 운영 개입 요구, 조사 우선순위 상향

## 9. 마일스톤
1. Week 1: 이벤트 스키마 확정, ABI 정렬, 토픽 설계
2. Week 2: WSS 수집기 + Kafka raw 구축
3. Week 3: 정규화/멱등/누락복구(Replay) 구현
4. Week 4: AML 룰 엔진 + Alert 생성
5. Week 5: Gin 운영 API + 모니터링 대시보드
6. Week 6: Webhook 교차검증 + 부하/내결함성 테스트

## 10. 성공 지표(KPI)
- 수집 p95 지연: 3초 이하
- 이벤트 중복률: 0.01% 이하
- 누락률: 0.1% 이하
- DLQ 처리율: 24시간 내 95% 이상
- 재처리 완료율: 주간 기준 99% 이상
