# Apix API Specification

이 문서는 **Apix** 프로젝트의 공식 API 명세서입니다.
MVP 개발을 위한 핵심 엔드포인트(`auth`, `resource`, `verify`)를 정의하며, **x402 프로토콜** 흐름을 상세히 기술합니다.

---

## 1. 개요 (Overview)

*   **Base URL**: `https://api.apix.market/v1` (Production) / `http://localhost:3000/v1` (Dev)
*   **Authentication**: Bearer Token (JWT)
*   **Response Format**: 모든 응답은 `success`, `data`, `error` 필드를 포함하는 표준 래퍼(Standard Wrapper) 형식을 따릅니다.
*   **Monetary Values**: 암호화폐 금액은 정밀도 손실 방지를 위해 항상 **String** 타입(Wei 단위 등)으로 처리합니다.

---

## 2. API 명세 (OpenAPI 3.0 YAML)

아래의 YAML 코드를 [Swagger Editor](https://editor.swagger.io/)에 붙여넣어 시각화하거나, 코드 생성에 활용할 수 있습니다.

```yaml
openapi: 3.0.3
info:
  title: Apix API Specification
  description: |
    Apix 플랫폼의 REST API 명세서입니다. 
    x402 프로토콜(유료 API 호출 및 결제 검증)과 암호화폐 지갑 기반의 인증을 지원합니다.
  version: 1.0.0
  contact:
    name: Apix Development Team
    email: dev@apix.market

servers:
  - url: https://api.apix.market/v1
    description: Production Server
  - url: http://localhost:3000/v1
    description: Development Server

tags:
  - name: Auth
    description: 지갑 연결 및 인증
  - name: Resource
    description: 유료 리소스 접근 (x402 Trigger)
  - name: Payment
    description: 결제 검증 및 세션 승인

paths:
  /auth/connect:
    post:
      tags:
        - Auth
      summary: 지갑 연결 및 세션 생성 (Wallet Connect)
      description: |
        사용자의 Avalanche 지갑 주소와 서명된 메시지를 검증하여 세션(JWT)을 발급합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - properties:
                      data:
                        $ref: '#/components/schemas/AuthResponseData'
        '400':
          description: 잘못된 요청 (서명 불일치 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardError'

  /proxy/{listing_id}:
    get:
      tags:
        - Resource
      summary: 테스트용 유료 리소스 호출 (Trigger 402 Error)
      description: |
        프록시를 통해 유료 API 리소스에 접근을 시도합니다. 
        사용자가 접근 권한(크레딧/구독)이 없을 경우 `402 Payment Required` 에러를 반환하며, 
        응답 본문에 결제에 필요한 컨텍스트(`payment_context`)를 포함합니다.
      parameters:
        - name: listing_id
          in: path
          required: true
          schema:
            type: string
            example: "sample_listing_01"
          description: 접근할 리스팅의 ID
      security:
        - bearerAuth: []
        - {} # 인증이 없어도 402 응답을 받을 수 있도록 허용 가능 (구현 정책에 따름)
      responses:
        '200':
          description: 접근 성공 (이미 결제됨 또는 무료)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - properties:
                      data:
                        type: object
                        example: { "message": "Secure Data Content", "value": 12345 }
        '402':
          description: 결제 필요 (Payment Required)
          headers:
            X-Apix-Request-ID:
              description: 결제 요청을 식별하는 고유 ID
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error402'
        '401':
          description: 인증 실패

  /verify:
    post:
      tags:
        - Payment
      summary: 결제 트랜잭션 검증 (Verify Payment)
      description: |
        클라이언트가 블록체인 상에서 지불을 완료한 후, 
        생성된 `tx_hash`와 `request_id`를 서버로 전송하여 유효성을 검증합니다.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyRequest'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 검증 성공
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - properties:
                      data:
                        $ref: '#/components/schemas/VerifyResponseData'
        '400':
          description: 검증 실패 (트랜잭션 조회 실패, 금액 불일치 등)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- Standard Wrappers ---
    StandardResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        error:
          type: object
          nullable: true
          example: null
        data:
          type: object
          nullable: true

    StandardError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "BAD_REQUEST"
            message:
              type: string
              example: "Input validation failed"
        data:
          type: object
          nullable: true

    # --- Domain Schemas ---
    AuthRequest:
      type: object
      required:
        - walletAddress
        - signature
        - message
      properties:
        walletAddress:
          type: string
          description: 사용자의 지갑 주소
          example: "0x71C7656EC7ab88b098defB751B7401B5f6d8976F"
        signature:
          type: string
          description: message에 대한 전자서명 값
          example: "0xabcdef..."
        message:
          type: string
          description: 서명된 원본 메시지 (타임스탬프 포함 권장)
          example: "Login to Apix: 1700000000"

    AuthResponseData:
      type: object
      properties:
        accessToken:
          type: string
          example: "eyJhbGciOiJIUzI1..."
        expiresIn:
          type: integer
          example: 3600
        userRole:
          type: string
          example: "user"

    VerifyRequest:
      type: object
      required:
        - request_id
        - tx_hash
      properties:
        request_id:
          type: string
          description: 402 응답 시 발급받은 요청 ID
          example: "req_550e8400-e29b-41d4-a716-446655440000"
        tx_hash:
          type: string
          description: 블록체인에서 결제 완료 후 발생한 트랜잭션 해시
          example: "0x88df016429689c079f3b5f..."

    VerifyResponseData:
      type: object
      properties:
        status:
          type: string
          example: "verified"
        redirect_url:
          type: string
          description: (Optional) 원본 리소스로 리디렉션할 URL
          example: "https://api.apix.market/data/secure/123"
        access_token:
          type: string
          description: (Optional) 해당 리소스 접근을 위한 일회성/단기 토큰
        expires_in:
          type: integer
          description: (Optional) 토큰 유효 시간 (초 단위)
          example: 3600

    # --- x402 Specific Error Schema ---
    Error402:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "PAYMENT_REQUIRED"
            message:
              type: string
              example: "Micropayment required to access this resource."
        data:
          type: object
          properties:
            request_id:
              type: string
              example: "req_550e8400-e29b-41d4-a716-446655440000"
            payment_context:
              type: object
              description: 결제에 필요한 상세 정보
              properties:
                chain_id:
                  type: integer
                  example: 43114
                currency_symbol:
                  type: string
                  example: "AVAX"
                amount_wei:
                  type: string
                  description: 결제 금액 (Wei 단위, 문자열)
                  example: "10000000000000000"
                recipient_address:
                  type: string
                  example: "0xSellerAddress..."
                memo:
                  type: string
                  description: 트랜잭션에 포함해야 할 메모 또는 데이터
                  example: "req_550e8400..."
```
