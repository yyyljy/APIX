# Apix API Specification

This document is the official API specification for the **Apix** project.
It defines the core endpoints (`auth`, `resource`, `verify`) for MVP development and details the **x402 protocol** flow.

---

## 1. Overview

*   **Base URL**: `https://api.apix.market/v1` (Production) / `http://localhost:3000/v1` (Dev)
*   **Authentication**: Bearer Token (JWT)
*   **Response Format**: All responses follow a standard wrapper format containing `success`, `data`, and `error` fields.
*   **Monetary Values**: Crypto amounts are always handled as **Strings** (e.g., in Wei) to prevent precision loss.

---

## 2. API Specification (OpenAPI 3.0 YAML)

You can copy the YAML code below and paste it into [Swagger Editor](https://editor.swagger.io/) to visualize it or use it for code generation.

```yaml
openapi: 3.0.3
info:
  title: Apix API Specification
  description: |
    REST API specification for the Apix platform.
    Supports the x402 protocol (monetized API calls and payment verification) and cryptocurrency wallet-based authentication.
  version: 1.0.0
  contact:
    name: Apix Development Team
    email: dev@apix.market

servers:
  - url: https://api.apix.market/v1
    description: Production Server
  - url: http://localhost:3000/v1
    description: Development Server

tags:
  - name: Auth
    description: Wallet connection and authentication
  - name: Resource
    description: Monetized resource access (x402 Trigger)
  - name: Payment
    description: Payment verification and session approval

paths:
  /auth/connect:
    post:
      tags:
        - Auth
      summary: Wallet Connect and Session Creation
      description: |
        Verifies the user's Avalanche wallet address and signed message to issue a session (JWT).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        '200':
          description: Login Successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - properties:
                      data:
                        $ref: '#/components/schemas/AuthResponseData'
        '400':
          description: Invalid Request (e.g., Signature Mismatch)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardError'

  /proxy/{listing_id}:
    get:
      tags:
        - Resource
      summary: Access Monetized Resource (Trigger 402 Error)
      description: |
        Attempts to access a monetized API resource via proxy.
        If the user does not have access rights (credits/subscription), it returns a `402 Payment Required` error
        and includes the necessary payment context (`payment_context`) in the response body.
      parameters:
        - name: listing_id
          in: path
          required: true
          schema:
            type: string
            example: "sample_listing_01"
          description: ID of the listing to access
      security:
        - bearerAuth: []
        - {} # Allow 402 response even without auth (depending on implementation policy)
      responses:
        '200':
          description: Access Successful (Already paid or free)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - properties:
                      data:
                        type: object
                        example: { "message": "Secure Data Content", "value": 12345 }
        '402':
          description: Payment Required
          headers:
            X-Apix-Request-ID:
              description: Unique ID identifying the payment request
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error402'
        '401':
          description: Authentication Failed

  /verify:
    post:
      tags:
        - Payment
      summary: Verify Payment Transaction
      description: |
        Verifies the validity of the payment after the client completes it on the blockchain
        by sending the generated `tx_hash` and `request_id` to the server.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyRequest'
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Verification Successful
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/StandardResponse'
                  - properties:
                      data:
                        $ref: '#/components/schemas/VerifyResponseData'
        '400':
          description: Verification Failed (e.g., Invalid TX, Amount Mismatch)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StandardError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- Standard Wrappers ---
    StandardResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        error:
          type: object
          nullable: true
          example: null
        data:
          type: object
          nullable: true

    StandardError:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "BAD_REQUEST"
            message:
              type: string
              example: "Input validation failed"
        data:
          type: object
          nullable: true

    # --- Domain Schemas ---
    AuthRequest:
      type: object
      required:
        - walletAddress
        - signature
        - message
      properties:
        walletAddress:
          type: string
          description: User's wallet address
          example: "0x71C7656EC7ab88b098defB751B7401B5f6d8976F"
        signature:
          type: string
          description: Digital signature for the message
          example: "0xabcdef..."
        message:
          type: string
          description: Original signed message (Timestamp recommended)
          example: "Login to Apix: 1700000000"

    AuthResponseData:
      type: object
      properties:
        accessToken:
          type: string
          example: "eyJhbGciOiJIUzI1..."
        expiresIn:
          type: integer
          example: 3600
        userRole:
          type: string
          example: "user"

    VerifyRequest:
      type: object
      required:
        - request_id
        - tx_hash
      properties:
        request_id:
          type: string
          description: Request ID received from the 402 response
          example: "req_550e8400-e29b-41d4-a716-446655440000"
        tx_hash:
          type: string
          description: Transaction hash generated after on-chain payment completion
          example: "0x88df016429689c079f3b5f..."

    VerifyResponseData:
      type: object
      properties:
        status:
          type: string
          example: "verified"
        redirect_url:
          type: string
          description: (Optional) URL to redirect to the original resource
          example: "https://api.apix.market/data/secure/123"
        access_token:
          type: string
          description: (Optional) One-time/Short-term token for accessing the resource
        expires_in:
          type: integer
          description: (Optional) Token expiration time in seconds
          example: 3600

    # --- x402 Specific Error Schema ---
    Error402:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
              example: "PAYMENT_REQUIRED"
            message:
              type: string
              example: "Micropayment required to access this resource."
        data:
          type: object
          properties:
            request_id:
              type: string
              example: "req_550e8400-e29b-41d4-a716-446655440000"
            payment_context:
              type: object
              description: Detailed information required for payment
              properties:
                chain_id:
                  type: integer
                  example: 43114
                currency_symbol:
                  type: string
                  example: "AVAX"
                amount_wei:
                  type: string
                  description: Payment amount (in Wei, as String)
                  example: "10000000000000000"
                recipient_address:
                  type: string
                  example: "0xSellerAddress..."
                memo:
                  type: string
                  description: Memo or data to include in the transaction
                  example: "req_550e8400..."
```
